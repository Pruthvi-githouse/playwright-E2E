name: Playwright Tests with Allure Report

# Trigger this workflow when code is pushed to the main branch OR on hourly schedule
on:
  push:
    branches: [main]
  schedule:
    - cron: '0 * * * *'  # Run every hour at minute 0 (UTC)

jobs:
  # Define the test job that runs on GitHub's Ubuntu runner
  test:
    runs-on: ubuntu-latest
    
    # Set strategy for test execution
    strategy:
      # Continue running other jobs even if one fails
      fail-fast: false
      matrix:
        # Can be extended for parallel execution across multiple Node versions
        node-version: [18.x]

    steps:
      # =====================================================
      # STEP 1: Checkout the code from the repository
      # =====================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for better reporting

      # =====================================================
      # STEP 2: Setup Node.js environment
      # =====================================================
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'  # Cache npm dependencies for faster builds

      # =====================================================
      # STEP 3: Install project dependencies
      # =====================================================
      - name: Install dependencies
        run: npm ci  # Using ci instead of install for CI/CD (more reliable)

      # =====================================================
      # STEP 4: Install Playwright browsers
      # =====================================================
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # =====================================================
      # STEP 5: Run Playwright tests in headless mode
      # =====================================================
      - name: Run Playwright tests
        run: npm test
        # Tests will generate results in allure-results/ folder
        # Continue even if tests fail so we can generate reports
        continue-on-error: true

      # =====================================================
      # STEP 6: Generate Allure report from test results
      # =====================================================
      - name: Generate Allure Report
        if: always()  # Run even if tests failed
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report

      # =====================================================
      # STEP 7: Upload Allure report as artifact
      # =====================================================
      - name: Upload Allure Report
        if: always()  # Run even if tests failed
        uses: actions/upload-artifact@v4
        with:
          # Name of the artifact (visible in GitHub UI)
          name: allure-report
          # Path to the generated Allure report
          path: allure-report/
          # Keep artifact for 30 days
          retention-days: 30

      # =====================================================
      # STEP 8: Upload test results for debugging
      # =====================================================
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      # =====================================================
      # STEP 9: Upload Allure results (raw data)
      # =====================================================
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results/
          retention-days: 7

      # =====================================================
      # STEP 10: Install nodemailer for email notifications
      # =====================================================
      - name: Install nodemailer
        if: always()
        run: npm install nodemailer

      # =====================================================
      # STEP 11: Send email notification with test results
      # =====================================================
      - name: Send Test Report Email
        if: always()
        run: node scripts/sendTestReport.js
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          STAKEHOLDER_EMAIL: ${{ secrets.STAKEHOLDER_EMAIL }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        continue-on-error: true  # Don't fail pipeline if email fails

      # =====================================================
      # STEP 12: Print test summary
      # =====================================================
      - name: Test Summary
        if: always()
        run: |
          echo "======================================"
          echo "âœ… CI/CD Pipeline Completed"
          echo "======================================"
          echo "ðŸ“Š Artifacts Generated:"
          echo "   â€¢ Allure Report (main dashboard)"
          echo "   â€¢ Playwright Report (HTML report)"
          echo "   â€¢ Allure Results (raw data)"
          echo ""
          echo "ðŸ“§ Email Notification:"
          echo "   â€¢ Test results sent to configured email"
          echo "   â€¢ Check GitHub Secrets for status"
          echo ""
          echo "ðŸ“¥ Download Artifacts:"
          echo "   1. Go to Actions tab"
          echo "   2. Click on the latest workflow run"
          echo "   3. Scroll down to 'Artifacts' section"
          echo "   4. Download 'allure-report' (Recommended)"
          echo "======================================"
